From a877583f07b39f3cb5fa5be83a913b5380abfb8e Mon Sep 17 00:00:00 2001
From: Amit Prakash Ambasta <amit.prakash.ambasta@gmail.com>
Date: Wed, 24 Nov 2021 12:22:46 +0530
Subject: [PATCH 1/2] Build without X, build with ozone

---
 build/gyp.mozbuild    |  1 +
 toolkit/moz.configure | 13 +++++++------
 2 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/build/gyp.mozbuild b/build/gyp.mozbuild
index 7499f6c460..9fe0ede9f5 100644
--- a/build/gyp.mozbuild
+++ b/build/gyp.mozbuild
@@ -14,6 +14,7 @@ gyp_vars.update({
     'fuzzing' : 1 if CONFIG['FUZZING'] else 0,
     'libfuzzer' : 1 if CONFIG['LIBFUZZER'] else 0,
     'libfuzzer_fuzzer_no_link_flag' : 1 if CONFIG['HAVE_LIBFUZZER_FLAG_FUZZER_NO_LINK'] else 0,
+    'use_ozone': 1,
     'build_with_mozilla': 1,
     'build_with_chromium': 0,
     # 10.9 once we move to TC cross-compiles - bug 1270217
diff --git a/toolkit/moz.configure b/toolkit/moz.configure
index 1e704a4765..b5e0173f4f 100644
--- a/toolkit/moz.configure
+++ b/toolkit/moz.configure
@@ -308,12 +308,14 @@ def toolkit_define(toolkit):
 
 set_define(toolkit_define, True)
 
+@depends(full_toolkit)
+def toolkit_gtk_nowayland(toolkit):
+    return toolkit.startswith("cairo-gtk3") and "wayland" not in toolkit
 
 @depends(toolkit)
 def toolkit_gtk(toolkit):
     return toolkit == "gtk"
 
-
 # Wayland support
 # ==============================================================
 wayland_headers = pkg_check_modules(
@@ -323,7 +325,6 @@ wayland_headers = pkg_check_modules(
     when=depends(full_toolkit)(lambda t: t in ("cairo-gtk3", "cairo-gtk3-wayland")),
 )
 
-
 @depends(wayland_headers, toolkit_gtk, artifact_builds)
 def wayland_headers(wayland, toolkit_gtk, artifacts):
     if toolkit_gtk and artifacts:
@@ -1208,11 +1209,11 @@ set_define("MOZ_RAW", depends_if("--enable-raw")(lambda _: True))
 
 # X11
 # ==============================================================
-set_config("MOZ_X11", True, when=toolkit_gtk)
-set_define("MOZ_X11", True, when=toolkit_gtk)
+set_config("MOZ_X11", True, when=toolkit_gtk_nowayland)
+set_define("MOZ_X11", True, when=toolkit_gtk_nowayland)
 
 
-@depends(webrtc, when=toolkit_gtk)
+@depends(webrtc, when=toolkit_gtk_nowayland)
 def x11_libs(webrtc):
     libs = [
         "x11",
@@ -1235,7 +1236,7 @@ def x11_libs(webrtc):
     return " ".join(libs)
 
 
-pkg_check_modules("MOZ_X11", x11_libs, when=toolkit_gtk)
+pkg_check_modules("MOZ_X11", x11_libs, when=toolkit_gtk_nowayland)
 
 
 # ASan Reporter Addon
-- 
2.34.0

